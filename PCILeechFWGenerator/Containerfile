# Note: Kernel module (donor_dump) should be built on target system, not in container
# The module requires kernel headers matching the host kernel version
# Build instructions are available in src/donor_dump/Makefile

# ---------- build stage for VFIO constants ----------
FROM ubuntu:24.04 AS build

ENV DEBIAN_FRONTEND=noninteractive \
    LANG=C.UTF-8 LC_ALL=C.UTF-8 TZ=UTC \
    PIP_BREAK_SYSTEM_PACKAGES=1

# ── base build deps ──────────────────────────────────────────────────────────
RUN apt-get update && apt-get install -y --no-install-recommends \
        python3 python3-pip build-essential \
        linux-headers-generic \
        pciutils kmod ca-certificates git && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /src

# ── Clone voltcyclone-fpga repository during build ───────────────────────────
# This eliminates user errors with git submodules
RUN mkdir -p lib && \
    git clone --depth 1 https://github.com/VoltCyclone/voltcyclone-fpga.git lib/voltcyclone-fpga && \
    echo "✓ voltcyclone-fpga cloned successfully" && \
    ls -la lib/voltcyclone-fpga/

# ── VFIO constants patching ───────────────────────────────────────────────────
COPY vfio_helper.c patch_vfio_constants.py build_vfio_constants.sh ./
COPY src/cli/vfio_constants.py ./src/cli/
RUN mkdir -p src/cli && \
    chmod +x build_vfio_constants.sh && \
    (./build_vfio_constants.sh && cp src/cli/vfio_constants.py vfio_constants_patched.py) || \
    (echo "⚠ VFIO constants build failed, using original" && cp src/cli/vfio_constants.py vfio_constants_patched.py) && \
    echo "Content of patched file:" && head -20 vfio_constants_patched.py | grep -A 10 "Ioctl numbers" || echo "No ioctl numbers section found"

# ---------- runtime ----------
FROM ubuntu:24.04 AS runtime

ENV DEBIAN_FRONTEND=noninteractive \
    LANG=C.UTF-8 LC_ALL=C.UTF-8 TZ=UTC \
    PIP_BREAK_SYSTEM_PACKAGES=1 \
    PCILEECH_PRODUCTION_MODE=true \
    PCILEECH_ALLOW_MOCK_DATA=false \
    PCILEECH_CONTAINER_MODE=true \
    SETUPTOOLS_SCM_PRETEND_VERSION=1.0.0

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        python3 python3-pip pciutils bsdextrautils kmod ca-certificates git sudo \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Create non-root user and configure sudo
RUN useradd -m -r appuser && \
    echo "appuser ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers && \
    echo "Defaults !requiretty" >> /etc/sudoers

WORKDIR /app

# Copy requirements and install Python dependencies
COPY requirements.txt requirements-tui.txt ./
RUN pip3 install --no-cache-dir -r requirements.txt -r requirements-tui.txt

# Copy application files
COPY src ./src
COPY configs ./configs
COPY pcileech.py .
COPY pyproject.toml setup.py setup.cfg ./

# Install the package itself so `from pcileechfwgenerator.xxx` imports work
# Note: Use regular install (not editable) since source is copied, not mounted
RUN pip3 install --no-cache-dir -v . 2>&1 | tail -50

# DEBUG: Verify installation succeeded
RUN echo "=== DEBUG: Checking pip installation ===" && \
    pip3 show pcileechfwgenerator && \
    echo "=== DEBUG: Checking site-packages ===" && \
    ls -la /usr/local/lib/python3.12/dist-packages/ | grep -i pcileech || echo "NOT FOUND in dist-packages" && \
    echo "=== DEBUG: Checking if module is importable ===" && \
    python3 -c "import pcileechfwgenerator; print('SUCCESS: pcileechfwgenerator imported from', pcileechfwgenerator.__file__)" || echo "FAILED to import" && \
    echo "=== DEBUG: Checking build module ===" && \
    python3 -c "from pcileechfwgenerator import build; print('SUCCESS: build module found')" || echo "FAILED to import build" && \
    echo "=== DEBUG: List package contents ===" && \
    ls -la /usr/local/lib/python3.12/dist-packages/pcileechfwgenerator/ 2>/dev/null | head -20 || echo "Package dir not found"

# Copy voltcyclone-fpga from build stage (cloned during build)
COPY --from=build /src/lib/voltcyclone-fpga ./lib/voltcyclone-fpga

# Copy the patched VFIO constants to the INSTALLED package location
# This replaces the installed vfio_constants.py with the patched version
COPY --from=build /src/vfio_constants_patched.py /usr/local/lib/python3.12/dist-packages/pcileechfwgenerator/cli/vfio_constants.py

# CRITICAL: Remove /app/src to prevent it from shadowing the installed package
# The package is installed to site-packages, /app/src/ would interfere with imports
RUN rm -rf /app/src

# DEBUG: Final verification after cleanup
RUN echo "=== DEBUG: Final import check ===" && \
    python3 -c "import pcileechfwgenerator.build; print('SUCCESS: pcileechfwgenerator.build is importable')" || \
    (echo "FAILED: Cannot import pcileechfwgenerator.build" && python3 -c "import sys; print('Python path:', sys.path)" && exit 1)

# Copy and setup entrypoint
COPY entrypoint.sh /usr/local/bin/entrypoint
RUN chmod 755 /usr/local/bin/entrypoint

# Set up environment and permissions
# Note: Package is installed via pip, so we only need /app for local scripts
# Do NOT include /app/src as it shadows the installed package imports
ENV PYTHONPATH=/app
RUN mkdir -p /app/output && chown appuser /app/output

# Health check to verify essential dependencies
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python3 -c "import psutil, pydantic, sys; sys.exit(0)" || exit 1

USER appuser
ENTRYPOINT ["/usr/local/bin/entrypoint"]
